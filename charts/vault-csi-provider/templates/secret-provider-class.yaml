# SecretProviderClass for GuardianShield API Management
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: {{ include "dhi-vault-csi-provider.fullname" . }}-secrets
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "dhi-vault-csi-provider.labels" . | nindent 4 }}
    guardianshield.io/component: "secret-provider"
spec:
  provider: vault
  
  # Vault-specific parameters
  parameters:
    vaultAddress: {{ include "dhi-vault-csi-provider.vaultAddress" . }}
    vaultNamespace: "{{ .Release.Namespace }}"
    roleName: "guardianshield-admin"
    
    {{- if not .Values.global.tlsDisable }}
    vaultCACertPath: "/vault/tls/ca.crt"
    vaultTLSClientCertPath: "/vault/tls/tls.crt"
    vaultTLSClientKeyPath: "/vault/tls/tls.key"
    {{- else }}
    vaultSkipTLSVerify: "true"
    {{- end }}
    
    # Secret objects to retrieve from Vault
    objects: |
      - objectName: "api-keys"
        secretPath: "guardianshield/api/keys"
        secretKey: "api_key"
      - objectName: "api-secret"
        secretPath: "guardianshield/api/keys"
        secretKey: "api_secret"
      - objectName: "jwt-secret"
        secretPath: "guardianshield/api/keys"
        secretKey: "jwt_secret"
      - objectName: "database-password"
        secretPath: "guardianshield/database/credentials"
        secretKey: "password"
      - objectName: "redis-password"
        secretPath: "guardianshield/redis/credentials"
        secretKey: "password"
      {{- if .Values.apiManagement.enabled }}
      - objectName: "oauth2-client-id"
        secretPath: "guardianshield/oauth2/client"
        secretKey: "client_id"
      - objectName: "oauth2-client-secret"
        secretPath: "guardianshield/oauth2/client"
        secretKey: "client_secret"
      {{- end }}
  
  # Create Kubernetes secrets from Vault secrets
  secretObjects:
    - secretName: guardianshield-api-secrets
      type: Opaque
      data:
        - objectName: api-keys
          key: api_key
        - objectName: api-secret
          key: api_secret
        - objectName: jwt-secret
          key: jwt_secret
    
    - secretName: guardianshield-database-secrets
      type: Opaque
      data:
        - objectName: database-password
          key: password
    
    - secretName: guardianshield-redis-secrets
      type: Opaque
      data:
        - objectName: redis-password
          key: password
    
    {{- if .Values.apiManagement.enabled }}
    - secretName: guardianshield-oauth2-secrets
      type: Opaque
      data:
        - objectName: oauth2-client-id
          key: client_id
        - objectName: oauth2-client-secret
          key: client_secret
    {{- end }}

---
# Additional SecretProviderClass for threat intelligence secrets
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: {{ include "dhi-vault-csi-provider.fullname" . }}-threat-intel-secrets
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "dhi-vault-csi-provider.labels" . | nindent 4 }}
    guardianshield.io/component: "threat-intel-secrets"
spec:
  provider: vault
  
  parameters:
    vaultAddress: {{ include "dhi-vault-csi-provider.vaultAddress" . }}
    vaultNamespace: "{{ .Release.Namespace }}"
    roleName: "guardianshield-developer"
    
    {{- if not .Values.global.tlsDisable }}
    vaultCACertPath: "/vault/tls/ca.crt"
    vaultTLSClientCertPath: "/vault/tls/tls.crt"
    vaultTLSClientKeyPath: "/vault/tls/tls.key"
    {{- else }}
    vaultSkipTLSVerify: "true"
    {{- end }}
    
    objects: |
      - objectName: "threat-feed-api-key"
        secretPath: "guardianshield/threat-intel/feeds"
        secretKey: "api_key"
      - objectName: "threat-feed-secret"
        secretPath: "guardianshield/threat-intel/feeds"
        secretKey: "secret"
      - objectName: "blockchain-rpc-endpoint"
        secretPath: "guardianshield/blockchain/config"
        secretKey: "rpc_endpoint"
      - objectName: "blockchain-api-key"
        secretPath: "guardianshield/blockchain/config"
        secretKey: "api_key"
  
  secretObjects:
    - secretName: guardianshield-threat-feed-secrets
      type: Opaque
      data:
        - objectName: threat-feed-api-key
          key: api_key
        - objectName: threat-feed-secret
          key: secret
    
    - secretName: guardianshield-blockchain-secrets
      type: Opaque
      data:
        - objectName: blockchain-rpc-endpoint
          key: rpc_endpoint
        - objectName: blockchain-api-key
          key: api_key

---
# SecretProviderClass for monitoring and observability
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: {{ include "dhi-vault-csi-provider.fullname" . }}-monitoring-secrets
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "dhi-vault-csi-provider.labels" . | nindent 4 }}
    guardianshield.io/component: "monitoring-secrets"
spec:
  provider: vault
  
  parameters:
    vaultAddress: {{ include "dhi-vault-csi-provider.vaultAddress" . }}
    vaultNamespace: "{{ .Release.Namespace }}"
    roleName: "guardianshield-readonly"
    
    {{- if not .Values.global.tlsDisable }}
    vaultCACertPath: "/vault/tls/ca.crt"
    {{- else }}
    vaultSkipTLSVerify: "true"
    {{- end }}
    
    objects: |
      - objectName: "prometheus-token"
        secretPath: "guardianshield/monitoring/prometheus"
        secretKey: "token"
      - objectName: "grafana-admin-password"
        secretPath: "guardianshield/monitoring/grafana"
        secretKey: "admin_password"
      - objectName: "alertmanager-webhook-url"
        secretPath: "guardianshield/monitoring/alertmanager"
        secretKey: "webhook_url"
  
  secretObjects:
    - secretName: guardianshield-monitoring-secrets
      type: Opaque
      data:
        - objectName: prometheus-token
          key: token
        - objectName: grafana-admin-password
          key: admin_password
        - objectName: alertmanager-webhook-url
          key: webhook_url