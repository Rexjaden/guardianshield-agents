# GuardianShield OpenSearch Dashboards Configuration
# Optimized for threat intelligence analytics and Web3 security monitoring

opensearch-dashboards:
  enabled: true
  
  image:
    repository: opensearchproject/opensearch-dashboards
    tag: "2.11.1"
    pullPolicy: IfNotPresent

  replicaCount: 2

  # Resource configuration optimized for GuardianShield workloads
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 4Gi

  # Environment-specific configurations
  config:
    # OpenSearch cluster connection
    opensearch.hosts: ["https://opensearch-cluster-master:9200"]
    opensearch.ssl.verificationMode: certificate
    opensearch.username: ${OPENSEARCH_USERNAME}
    opensearch.password: ${OPENSEARCH_PASSWORD}
    opensearch.requestHeadersWhitelist: ["securitytenant","Authorization"]

    # Server configuration
    server.name: "guardianshield-dashboards"
    server.host: "0.0.0.0"
    server.port: 5601
    server.ssl.enabled: true
    server.ssl.certificate: /usr/share/opensearch-dashboards/config/certs/tls.crt
    server.ssl.key: /usr/share/opensearch-dashboards/config/certs/tls.key

    # Security configuration for GuardianShield
    opensearch_security.multitenancy.enabled: true
    opensearch_security.multitenancy.tenants.enable_global: true
    opensearch_security.multitenancy.tenants.enable_private: true
    opensearch_security.multitenancy.tenants.preferred: ["Private", "Global"]
    opensearch_security.readonly_mode.roles: ["kibana_read_only"]

    # GuardianShield-specific settings
    logging.level: info
    ops.interval: 30000
    
    # Custom branding
    opensearchDashboards.branding:
      logo:
        defaultUrl: "/ui/logos/guardianshield-logo.svg"
        darkModeUrl: "/ui/logos/guardianshield-logo-dark.svg"
      mark:
        defaultUrl: "/ui/logos/guardianshield-mark.svg"
        darkModeUrl: "/ui/logos/guardianshield-mark-dark.svg"
      title: "GuardianShield Analytics"
      favicon: "/ui/favicons/favicon.ico"

  # Service configuration
  service:
    type: ClusterIP
    port: 5601
    targetPort: 5601
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-type: nlb
      service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"

  # Ingress for external access
  ingress:
    enabled: true
    className: nginx
    annotations:
      kubernetes.io/ingress.class: nginx
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
      nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
      nginx.ingress.kubernetes.io/proxy-body-size: "50m"
      nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
      nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    hosts:
      - host: dashboards.guardianshield.io
        paths:
          - path: /
            pathType: Prefix
      - host: analytics.guardianshield.io
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: guardianshield-dashboards-tls
        hosts:
          - dashboards.guardianshield.io
          - analytics.guardianshield.io

  # Persistence for plugins and configurations
  persistence:
    enabled: true
    storageClass: "gp3"
    accessMode: ReadWriteOnce
    size: 10Gi

  # Security context
  securityContext:
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000

  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000

  # Node selection for performance
  nodeSelector:
    kubernetes.io/arch: amd64
    node-type: analytics

  tolerations:
    - key: "dedicated"
      operator: "Equal"
      value: "analytics"
      effect: "NoSchedule"

  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - opensearch-dashboards
            topologyKey: kubernetes.io/hostname

  # Health checks
  readinessProbe:
    httpGet:
      path: /api/status
      port: 5601
      scheme: HTTPS
    initialDelaySeconds: 60
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 6
    successThreshold: 1

  livenessProbe:
    httpGet:
      path: /api/status
      port: 5601
      scheme: HTTPS
    initialDelaySeconds: 120
    periodSeconds: 20
    timeoutSeconds: 10
    failureThreshold: 3

  # Environment variables for GuardianShield integration
  extraEnvs:
    - name: GUARDIANSHIELD_ENV
      value: "production"
    - name: THREAT_INTEL_API_URL
      value: "https://api.guardianshield.io/v1/threat-intel"
    - name: WEB3_ANALYTICS_ENABLED
      value: "true"
    - name: DMER_INTEGRATION_ENABLED
      value: "true"
    - name: FLARE_NETWORK_MONITORING
      value: "true"

  # Custom plugins for GuardianShield
  plugins:
    enabled: true
    installList:
      - "https://github.com/guardianshield-agents/opensearch-dashboards-plugins/releases/download/v1.0.0/guardian-threat-intel-plugin.zip"
      - "https://github.com/guardianshield-agents/opensearch-dashboards-plugins/releases/download/v1.0.0/web3-security-plugin.zip"
      - "https://github.com/guardianshield-agents/opensearch-dashboards-plugins/releases/download/v1.0.0/dmer-integration-plugin.zip"

# Custom configurations for GuardianShield analytics
guardianshield:
  analytics:
    # Threat intelligence dashboards
    threatIntel:
      enabled: true
      refreshInterval: "30s"
      retentionDays: 90
      alerting:
        enabled: true
        webhookUrl: "https://api.guardianshield.io/v1/alerts"
    
    # Web3 and blockchain monitoring
    web3:
      enabled: true
      networks:
        - ethereum
        - flare
        - arbitrum
        - polygon
      dmerIntegration: true
    
    # Security monitoring
    security:
      enabled: true
      auditLogs: true
      complianceReporting: true
      
    # Performance monitoring
    performance:
      enabled: true
      metricsCollection: true
      customDashboards: true

  # Data retention policies
  dataRetention:
    threatIntelligence: "90d"
    securityLogs: "1y"
    web3Transactions: "180d"
    auditLogs: "2y"

  # Backup configuration
  backup:
    enabled: true
    schedule: "0 2 * * *"  # Daily at 2 AM
    retention: "30d"
    storageClass: "gp3"

# Monitoring and observability
monitoring:
  prometheus:
    enabled: true
    port: 9108
    path: /metrics
  
  grafana:
    dashboards:
      enabled: true
      folder: "GuardianShield Analytics"

# Network policies
networkPolicy:
  enabled: true
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: guardianshield-system
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: opensearch
      ports:
        - protocol: TCP
          port: 5601
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              name: guardianshield-system
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: opensearch
      ports:
        - protocol: TCP
          port: 9200