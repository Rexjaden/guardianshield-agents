{{- if .Values.monitoring.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{ include "dhi-cert-manager.fullname" . }}-cert-manager
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "dhi-cert-manager.labels" . | nindent 4 }}
    {{- include "dhi-cert-manager.monitoringLabels" . | nindent 4 }}
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: cert-manager
      app.kubernetes.io/component: controller
  endpoints:
  - port: http-metrics
    interval: {{ .Values.monitoring.scrapeInterval }}
    path: /metrics
    scheme: http
  namespaceSelector:
    matchNames:
    - cert-manager
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ include "dhi-cert-manager.fullname" . }}-cert-manager-alerts
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "dhi-cert-manager.labels" . | nindent 4 }}
    {{- include "dhi-cert-manager.monitoringLabels" . | nindent 4 }}
spec:
  groups:
  - name: cert-manager
    interval: {{ .Values.monitoring.alertRuleInterval }}
    rules:
    - alert: CertificateExpiringSoon
      expr: (certmanager_certificate_expiration_timestamp_seconds - time()) / 86400 < 30
      for: {{ .Values.monitoring.alertFor }}
      labels:
        severity: warning
        service: cert-manager
        team: guardianshield-security
      annotations:
        summary: "Certificate expiring soon"
        description: "Certificate {{ $labels.name }} in namespace {{ $labels.namespace }} expires in {{ $value }} days"
    
    - alert: CertificateNotReady
      expr: certmanager_certificate_ready_status == 0
      for: {{ .Values.monitoring.alertFor }}
      labels:
        severity: critical
        service: cert-manager
        team: guardianshield-security
      annotations:
        summary: "Certificate not ready"
        description: "Certificate {{ $labels.name }} in namespace {{ $labels.namespace }} is not ready"
    
    - alert: CertManagerControllerDown
      expr: up{job="cert-manager"} == 0
      for: {{ .Values.monitoring.alertFor }}
      labels:
        severity: critical
        service: cert-manager
        team: guardianshield-security
      annotations:
        summary: "Cert-manager controller is down"
        description: "Cert-manager controller has been down for more than {{ .Values.monitoring.alertFor }}"
    
    - alert: ACMEChallengesFailing
      expr: rate(certmanager_acme_client_request_count{status!~"2.."}[5m]) > 0.1
      for: {{ .Values.monitoring.alertFor }}
      labels:
        severity: warning
        service: cert-manager
        team: guardianshield-security
      annotations:
        summary: "ACME challenges failing"
        description: "ACME challenge failures detected for cert-manager"
{{- end }}