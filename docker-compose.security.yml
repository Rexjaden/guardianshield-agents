version: '3.8'

services:
  # Security-hardened API
  guardianshield-api-secure:
    build:
      context: .
      dockerfile: Dockerfile.security
    security_opt:
      - no-new-privileges:true
      - apparmor=docker-default
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp
      - /var/run
    user: "1001:1001"
    environment:
      - ENVIRONMENT=production
      - SECURITY_HARDENED=true
    networks:
      - guardianshield-secure
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Security Scanner
  trivy-scanner:
    image: aquasec/trivy:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - trivy-cache:/root/.cache/trivy
    command: ["image", "--exit-code", "1", "guardianshield/api:latest"]
    networks:
      - guardianshield-secure

  # Secret Management
  vault:
    image: vault:latest
    cap_add:
      - IPC_LOCK
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=${VAULT_TOKEN}
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
    ports:
      - "8200:8200"
    volumes:
      - vault-data:/vault/data
      - ./vault/config:/vault/config:ro
    networks:
      - guardianshield-secure
    command: ["vault", "server", "-config=/vault/config/vault.json"]

  # Network Security Scanner
  nmap-scanner:
    image: instrumentisto/nmap
    networks:
      - guardianshield-secure
    command: ["nmap", "-sT", "-O", "guardianshield-api-secure"]
    depends_on:
      - guardianshield-api-secure

  # Container Security Monitoring
  falco:
    image: falcosecurity/falco:latest
    privileged: true
    volumes:
      - /var/run/docker.sock:/host/var/run/docker.sock
      - /dev:/host/dev
      - /proc:/host/proc:ro
      - /boot:/host/boot:ro
      - /lib/modules:/host/lib/modules:ro
      - /usr:/host/usr:ro
      - /etc:/host/etc:ro
    networks:
      - guardianshield-secure

volumes:
  trivy-cache:
  vault-data:

networks:
  guardianshield-secure:
    driver: bridge