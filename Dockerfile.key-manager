# Secure Key Manager for GuardianShield Validators
FROM alpine:3.18

# Install security tools and python
RUN apk add --no-cache \
    openssl \
    gnupg \
    pass \
    age \
    sudo \
    curl \
    python3 \
    py3-pip \
    py3-cryptography

# Create key manager user
RUN addgroup -g 1000 keymgr && \
    adduser -D -u 1000 -G keymgr -h /home/keymgr keymgr

# Set working directory
WORKDIR /kms

# Install key management tools
COPY docker/key-manager/ ./

# Create secure directories
RUN mkdir -p /kms/keys /kms/data /kms/backup \
    && chown -R keymgr:keymgr /kms \
    && chmod 700 /kms/keys \
    && chmod 755 /kms/data \
    && chmod 700 /kms/backup

# Copy key management scripts
COPY secure_key_management.py ./
COPY docker/key-manager/entrypoint.sh ./

# Set permissions
RUN chmod +x ./entrypoint.sh \
    && chown keymgr:keymgr secure_key_management.py

# Drop to non-root user
USER keymgr

# Health check
HEALTHCHECK --interval=60s --timeout=10s --start-period=5s --retries=3 \
    CMD python3 -c "import secure_key_management; print('KMS Health: OK')" || exit 1

# Start key manager
CMD ["./entrypoint.sh"]