# ğŸ”— GuardianShield Chainlink Integration Guide\n\n## Overview\n\nThe GuardianShield token sale system now integrates with Chainlink Price Feeds to provide real-time ETH/USD pricing. This ensures accurate, decentralized price data for token sales across all supported networks.\n\n## ğŸ—ï¸ Architecture\n\n### Core Components\n\n1. **ChainlinkPriceOracle.sol** - Main oracle contract that interfaces with Chainlink price feeds\n2. **GuardianTokenSale.sol** - Updated token sale contract with dynamic pricing\n3. **Deploy Script** - Automated deployment with network-specific price feeds\n\n### Price Feed Integration Flow\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚   Chainlink     â”‚    â”‚ ChainlinkPrice   â”‚    â”‚ GuardianToken   â”‚\nâ”‚   ETH/USD       â”œâ”€â”€â”€â”€â”¤     Oracle       â”œâ”€â”€â”€â”€â”¤     Sale        â”‚\nâ”‚   Price Feed    â”‚    â”‚                  â”‚    â”‚                 â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n## ğŸ“‹ Supported Networks\n\n| Network | Chain ID | Price Feed Address |\n|---------|----------|-------------------|\n| Ethereum Mainnet | 1 | `0x5f4eC3Df9cbd43714FE2740f5E3616155c5b8419` |\n| Sepolia Testnet | 11155111 | `0x694AA1769357215DE4FAC081bf1f309aDC325306` |\n| Polygon Mainnet | 137 | `0xF9680D99D6C9589e2a93a78A04A279e509205945` |\n| Polygon Mumbai | 80001 | `0xd0D5e3DB44DE05E9F294BB0a3bEEaF030DE24Ada` |\n| BSC Mainnet | 56 | `0x0567F2323251f0Aab15c8dFb1967E4e8A7D42aeE` |\n| BSC Testnet | 97 | `0x2514895c72f50D8bd4B4F9b1110F0D6bD2c97526` |\n| Arbitrum One | 42161 | `0x639Fe6ab55C921f74e7fac1ee960C0B6293ba612` |\n| Arbitrum Sepolia | 421614 | `0xd30e2101a97dcbAeBCBC04F14C3f624E67A35165` |\n\n## ğŸ’° Token Pricing Structure\n\n### USD-Based Pricing Tiers\n\n| Stage | Description | Price (USD) | Discount | Max Tokens |\n|-------|-------------|-------------|----------|------------|\n| 1 | Pre-Sale | $0.001 | 50% | 50M GUARD |\n| 2 | Public Sale | $0.0015 | 25% | 100M GUARD |\n| 3 | Final Sale | $0.002 | 0% | 150M GUARD |\n\n### Dynamic ETH Pricing\n\nToken prices are automatically converted from USD to ETH using real-time Chainlink price feeds:\n\n```solidity\n// Example: $0.001 USD token price\nuint256 tokenPriceEth = oracle.usdToEth(0.001 ether);\n// If ETH = $3000, then token price = 0.001/3000 â‰ˆ 0.000000333 ETH\n```\n\n## ğŸš€ Deployment\n\n### Quick Deploy\n\n```bash\n# Deploy to Sepolia testnet with Chainlink integration\nnpm run deploy:sepolia\n\n# Deploy to mainnet with Chainlink integration\nnpm run deploy:mainnet\n\n# Deploy to any network\nnpm run deploy:chainlink -- --network <network-name>\n```\n\n### Manual Deployment Steps\n\n1. **Install Dependencies**\n   ```bash\n   npm install @chainlink/contracts\n   ```\n\n2. **Compile Contracts**\n   ```bash\n   npm run compile\n   ```\n\n3. **Deploy with Chainlink**\n   ```bash\n   npx hardhat run scripts/deploy-with-chainlink.js --network sepolia\n   ```\n\n4. **Verify Contracts**\n   ```bash\n   # Use verification commands from deployment output\n   npx hardhat verify --network sepolia <CONTRACT_ADDRESS> <CONSTRUCTOR_ARGS>\n   ```\n\n## ğŸ”§ Configuration\n\n### Oracle Settings\n\n```solidity\n// Toggle oracle usage\ntokenSale.toggleOracle(true/false);\n\n// Set fallback price (with 8 decimals)\ntokenSale.setFallbackEthPrice(3000_00000000); // $3000\n\n// Update stage pricing based on current rates\ntokenSale.updateStagesPricing();\n```\n\n### Price Feed Health Check\n\n```solidity\n// Check oracle status\n(bool healthy, string memory status) = priceOracle.isPriceFeedHealthy();\n\n// Get current price info\n(uint256 price, uint256 timestamp, bool success) = priceOracle.getLatestPrice();\n```\n\n## ğŸ“Š Usage Examples\n\n### Getting Current Prices\n\n```javascript\n// Get current ETH price\nconst [ethPrice, timestamp, success] = await priceOracle.getLatestPrice();\nconsole.log(`ETH Price: $${ethPrice / 1e8}`);\n\n// Get token price in USD\nconst tokenPriceUsd = await tokenSale.getTokenPriceInUsd(1); // Stage 1\nconsole.log(`Token Price: $${ethers.formatEther(tokenPriceUsd)}`);\n```\n\n### Purchasing Tokens\n\n```javascript\n// Buy tokens with ETH (price calculated dynamically)\nconst ethAmount = ethers.parseEther(\"1\"); // 1 ETH\nconst expectedTokens = await tokenSale.calculateTokens(ethAmount);\n\nconst tx = await tokenSale.buyTokens(ethers.ZeroAddress, {\n    value: ethAmount\n});\n```\n\n### Converting Prices\n\n```javascript\n// Convert ETH to USD\nconst ethAmount = ethers.parseEther(\"1\");\nconst usdValue = await priceOracle.ethToUsd(ethAmount);\n\n// Convert USD to ETH\nconst usdAmount = ethers.parseEther(\"3000\"); // $3000\nconst ethValue = await priceOracle.usdToEth(usdAmount);\n```\n\n## ğŸ§ª Testing\n\n### Run Chainlink Integration Tests\n\n```bash\n# Run all Chainlink-related tests\nnpm run test:chainlink\n\n# Run specific test file\nnpx hardhat test test/chainlink-integration.test.js\n```\n\n### Test Coverage Areas\n\n- âœ… Oracle price feed connectivity\n- âœ… Fallback price mechanism\n- âœ… Dynamic token pricing\n- âœ… USD/ETH conversions\n- âœ… Error handling and edge cases\n- âœ… Admin controls and configuration\n\n## âš ï¸ Safety Features\n\n### 1. Fallback Pricing\n- If Chainlink feed fails, system uses configurable fallback price\n- Default: $3000 USD per ETH\n- Admin can update fallback price\n\n### 2. Staleness Protection\n- Price data older than 1 hour triggers fallback\n- Prevents using outdated price information\n- Configurable staleness threshold\n\n### 3. Admin Controls\n- Oracle can be toggled on/off\n- Fallback prices can be updated\n- Stage pricing can be refreshed\n- Emergency withdrawal functions\n\n## ğŸ”’ Security Considerations\n\n### Oracle Security\n- Uses official Chainlink price feeds\n- Multiple validation layers\n- Graceful degradation to fallback pricing\n- No single point of failure\n\n### Access Control\n- Only owner can modify oracle settings\n- Price updates are automated\n- Admin functions are protected\n- Multi-sig treasury integration\n\n## ğŸ“ˆ Monitoring & Analytics\n\n### Price Tracking\n```javascript\n// Monitor price changes\npriceOracle.on(\"PriceUpdated\", (price, timestamp) => {\n    console.log(`New ETH Price: $${price / 1e8} at ${new Date(timestamp * 1000)}`);\n});\n\n// Track fallback usage\npriceOracle.on(\"FallbackPriceUsed\", (price, reason) => {\n    console.log(`Fallback price used: $${price / 1e8}, Reason: ${reason}`);\n});\n```\n\n### Sale Analytics\n```javascript\n// Get detailed sale information\nconst saleInfo = await tokenSale.getCurrentSaleInfo();\nconst {\n    stage, stageName, price, maxTokens, soldTokens, \n    remainingTokens, active, priceInUsd, oracleActive\n} = saleInfo;\n```\n\n## ğŸ› ï¸ Troubleshooting\n\n### Common Issues\n\n1. **Oracle Not Working**\n   - Check if Chainlink feed exists for your network\n   - Verify price feed address is correct\n   - Check if fallback pricing is enabled\n\n2. **High Gas Costs**\n   - Oracle calls add ~50k gas per transaction\n   - Consider batching operations\n   - Use view functions for price checks\n\n3. **Price Deviations**\n   - Ensure staleness threshold is appropriate\n   - Monitor fallback price accuracy\n   - Check for network congestion affecting feeds\n\n### Debug Commands\n\n```bash\n# Check oracle health\nnpx hardhat console --network sepolia\nconst oracle = await ethers.getContractAt(\"ChainlinkPriceOracle\", \"<ORACLE_ADDRESS>\");\nconst [healthy, status] = await oracle.isPriceFeedHealthy();\nconsole.log(`Oracle Health: ${healthy}, Status: ${status}`);\n```\n\n## ğŸ”„ Upgrades & Maintenance\n\n### Oracle Updates\n- New price feed addresses can be set by owner\n- Fallback prices should be updated regularly\n- Monitor Chainlink network status\n\n### Contract Upgrades\n- Consider proxy pattern for future upgrades\n- Test thoroughly on testnets first\n- Coordinate with multi-sig treasury\n\n## ğŸ“ Support\n\nFor issues or questions:\n- Check [Chainlink Documentation](https://docs.chain.link/)\n- Review contract source code\n- Run integration tests\n- Contact development team\n\n---\n\n**âš¡ Ready to go live with real-time pricing!** ğŸš€\n\nThe GuardianShield token sale now provides accurate, decentralized pricing through Chainlink's industry-standard oracle network.