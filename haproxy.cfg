global
    daemon
    maxconn 4096
    log stdout local0
    
    # Performance tuning
    tune.ssl.default-dh-param 2048
    tune.ssl.lifetime 300
    tune.ssl.maxrecord 1460

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    option redispatch
    retries 3
    
    # Health checks
    option httpchk GET /health

# Statistics interface
stats enable
stats uri /haproxy?stats
stats refresh 30s
stats admin if TRUE

frontend shield_token_frontend
    bind *:8000
    mode http
    
    # Security headers
    http-response set-header X-Frame-Options SAMEORIGIN
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    
    # CORS for Web3
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-response set-header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    
    # Rate limiting
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request reject if { sc_http_req_rate(0) gt 20 }
    
    # Route based on path
    acl is_api path_beg /api/
    acl is_websocket path_beg /ws
    acl is_static path_end .js .css .png .jpg .jpeg .gif .ico .svg .woff .woff2
    acl is_secure_api path_beg /api/v1/tokens /api/v1/purchase /api/v1/wallet
    
    # Use different backends based on content type
    use_backend shield_apigee_backend if is_secure_api
    use_backend shield_api_backend if is_api
    use_backend shield_websocket_backend if is_websocket
    use_backend shield_static_backend if is_static
    default_backend shield_web_backend

# Backend for secure API requests via Apigee Microgateway
backend shield_apigee_backend
    balance roundrobin
    option httpchk GET /health
    
    # Route secure API calls through Apigee for enterprise management
    server apigee1 shield-apigee-gateway:8443 check ssl verify none weight 3
    server openresty1 shield-openresty:80 check weight 1 backup

# Backend for API requests - high performance
backend shield_api_backend
    balance roundrobin
    option httpchk GET /health
    
    # Prefer OpenResty for API processing
    server openresty1 shield-openresty:80 check weight 3
    server caddy1 shield-caddy:80 check weight 1

# Backend for WebSocket connections - sticky sessions
backend shield_websocket_backend
    balance source  # Ensure WebSocket connections stick to same server
    option httpchk GET /health
    
    server openresty1 shield-openresty:80 check
    server caddy1 shield-caddy:80 check backup

# Backend for static assets - optimized caching
backend shield_static_backend
    balance leastconn
    option httpchk GET /health
    
    # Prefer Caddy for static asset serving
    server caddy1 shield-caddy:80 check weight 3
    server openresty1 shield-openresty:80 check weight 1

# Default backend for web traffic
backend shield_web_backend
    balance roundrobin
    option httpchk GET /health
    
    server caddy1 shield-caddy:80 check
    server openresty1 shield-openresty:80 check

# Backend for direct 3D API access
backend shield_3d_direct
    balance leastconn
    option httpchk GET /health
    
    server 3d-api1 shield-3d-api:9000 check

# Statistics backend
listen stats
    bind *:8888
    stats enable
    stats uri /
    stats refresh 10s
    stats admin if TRUE
    stats show-legends
    
    # Authentication (optional)
    # stats auth admin:shieldtoken2024