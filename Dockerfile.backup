# Automated Backup Service with Encryption
FROM postgres:15-alpine

# Install backup tools
RUN apk add --no-cache \
    python3 \
    py3-pip \
    aws-cli \
    gnupg \
    curl \
    cron

# Install Python backup libraries
RUN pip3 install schedule boto3 psycopg2-binary

# Create backup directory
RUN mkdir -p /app/backups

# Copy backup script
COPY <<EOF /app/backup_service.py
#!/usr/bin/env python3
import os
import schedule
import time
import subprocess
import datetime
import boto3
import logging
from pathlib import Path

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class BackupService:
    def __init__(self):
        self.db_url = os.getenv('DATABASE_URL')
        self.encryption_key = os.getenv('BACKUP_ENCRYPTION_KEY')
        self.s3_bucket = os.getenv('S3_BUCKET')
        self.backup_dir = Path('/app/backups')
        self.backup_dir.mkdir(exist_ok=True)
        
        # Initialize S3 client
        self.s3 = boto3.client('s3') if self.s3_bucket else None
    
    def create_database_backup(self):
        """Create encrypted database backup"""
        try:
            timestamp = datetime.datetime.now().strftime('%Y%m%d_%H%M%S')
            backup_file = self.backup_dir / f"guardianshield_backup_{timestamp}.sql"
            encrypted_file = self.backup_dir / f"guardianshield_backup_{timestamp}.sql.gpg"
            
            # Create database dump
            dump_cmd = [
                'pg_dump', self.db_url, 
                '--no-password', '--verbose',
                '-f', str(backup_file)
            ]
            
            result = subprocess.run(dump_cmd, capture_output=True, text=True)
            if result.returncode != 0:
                raise Exception(f"pg_dump failed: {result.stderr}")
            
            # Encrypt backup
            encrypt_cmd = [
                'gpg', '--cipher-algo', 'AES256', '--compress-algo', '1',
                '--symmetric', '--batch', '--yes', '--quiet',
                '--passphrase', self.encryption_key,
                '--output', str(encrypted_file),
                str(backup_file)
            ]
            
            result = subprocess.run(encrypt_cmd, capture_output=True)
            if result.returncode != 0:
                raise Exception("Backup encryption failed")
            
            # Remove unencrypted file
            backup_file.unlink()
            
            # Upload to S3 if configured
            if self.s3:
                s3_key = f"backups/{encrypted_file.name}"
                self.s3.upload_file(str(encrypted_file), self.s3_bucket, s3_key)
                logger.info(f"Backup uploaded to S3: {s3_key}")
            
            # Cleanup old backups (keep last 7 days)
            self.cleanup_old_backups()
            
            logger.info(f"Backup completed: {encrypted_file}")
            return encrypted_file
            
        except Exception as e:
            logger.error(f"Backup failed: {e}")
            return None
    
    def cleanup_old_backups(self):
        """Remove backups older than 7 days"""
        cutoff = datetime.datetime.now() - datetime.timedelta(days=7)
        
        for backup_file in self.backup_dir.glob("*.gpg"):
            if backup_file.stat().st_mtime < cutoff.timestamp():
                backup_file.unlink()
                logger.info(f"Removed old backup: {backup_file}")
    
    def run(self):
        """Schedule and run backups"""
        logger.info("Backup service started")
        
        # Schedule daily backup at 2 AM
        schedule.every().day.at("02:00").do(self.create_database_backup)
        
        # Schedule hourly incremental backups during business hours
        for hour in range(9, 18):  # 9 AM to 5 PM
            schedule.every().day.at(f"{hour:02d}:00").do(self.create_database_backup)
        
        while True:
            schedule.run_pending()
            time.sleep(60)

if __name__ == "__main__":
    backup_service = BackupService()
    backup_service.run()
EOF

RUN chmod +x /app/backup_service.py

# Start backup service
CMD ["python3", "/app/backup_service.py"]