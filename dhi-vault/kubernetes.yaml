apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: dhi-vault
  namespace: guardianshield
  labels:
    app: dhi-vault
    component: secrets-management
    guardianshield.io/project: GuardianShield
    guardianshield.io/security-layer: secrets-vault
spec:
  serviceName: dhi-vault-headless
  replicas: 3
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      partition: 0
  selector:
    matchLabels:
      app: dhi-vault
  template:
    metadata:
      labels:
        app: dhi-vault
        component: secrets-management
        guardianshield.io/security-layer: secrets-vault
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8200"
        prometheus.io/path: "/v1/sys/metrics"
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/role: "dhi-vault-role"
    spec:
      serviceAccountName: dhi-vault
      securityContext:
        runAsNonRoot: true
        runAsUser: 100
        fsGroup: 1000
        supplementalGroups: [1000]
      initContainers:
      - name: vault-init
        image: vault:1.15.4
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "Initializing Vault configuration..."
          # Create necessary directories
          mkdir -p /vault/data
          mkdir -p /vault/logs
          mkdir -p /vault/config
          
          # Set proper permissions
          chown -R vault:vault /vault/data
          chown -R vault:vault /vault/logs
          
          echo "Vault initialization complete"
        volumeMounts:
        - name: vault-data
          mountPath: /vault/data
        - name: vault-logs
          mountPath: /vault/logs
        securityContext:
          runAsUser: 100
          runAsGroup: 1000
      containers:
      - name: vault
        image: vault:1.15.4
        imagePullPolicy: Always
        ports:
        - containerPort: 8200
          name: http-api
          protocol: TCP
        - containerPort: 8201
          name: cluster-api
          protocol: TCP
        env:
        - name: VAULT_ADDR
          value: "http://127.0.0.1:8200"
        - name: VAULT_API_ADDR
          value: "http://$(POD_IP):8200"
        - name: VAULT_CLUSTER_ADDR
          value: "http://$(POD_IP):8201"
        - name: VAULT_LOG_LEVEL
          value: "INFO"
        - name: VAULT_LOG_FORMAT
          value: "json"
        - name: VAULT_DISABLE_MLOCK
          value: "true"
        - name: VAULT_UI
          value: "true"
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        args:
        - "vault"
        - "server"
        - "-config=/vault/config/vault.hcl"
        volumeMounts:
        - name: vault-config
          mountPath: /vault/config
          readOnly: true
        - name: vault-data
          mountPath: /vault/data
        - name: vault-logs
          mountPath: /vault/logs
        - name: vault-tls
          mountPath: /vault/tls
          readOnly: true
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
            ephemeral-storage: "1Gi"
          limits:
            memory: "512Mi"
            cpu: "500m"
            ephemeral-storage: "2Gi"
        livenessProbe:
          httpGet:
            path: /v1/sys/health
            port: 8200
            scheme: HTTP
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /v1/sys/health?standbyok=true
            port: 8200
            scheme: HTTP
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        startupProbe:
          httpGet:
            path: /v1/sys/health?standbyok=true&sealedcode=200&uninitcode=200
            port: 8200
            scheme: HTTP
          initialDelaySeconds: 15
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 30
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 100
          runAsGroup: 1000
          capabilities:
            drop:
            - ALL
            add:
            - IPC_LOCK
      - name: dhi-vault-api
        image: guardianshield/dhi-vault:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
          name: python-api
          protocol: TCP
        env:
        - name: VAULT_ADDR
          value: "http://127.0.0.1:8200"
        - name: VAULT_TOKEN
          valueFrom:
            secretKeyRef:
              name: dhi-vault-token
              key: vault-token
        - name: PYTHONPATH
          value: "/app"
        - name: REDIS_URL
          value: "redis://redis.guardianshield.svc.cluster.local:6379/5"
        - name: POSTGRES_URL
          value: "postgresql://vault_user:vault_pass@postgres.guardianshield.svc.cluster.local:5432/vault_db"
        - name: MAX_SECRETS_PER_PATH
          value: "1000"
        - name: AUDIT_LOG_ENABLED
          value: "true"
        - name: ENCRYPTION_KEY_ROTATION_DAYS
          value: "30"
        - name: AUTO_UNSEAL_ENABLED
          value: "true"
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        volumeMounts:
        - name: vault-api-config
          mountPath: /app/config
          readOnly: true
        - name: vault-audit-logs
          mountPath: /app/audit-logs
        - name: vault-data
          mountPath: /app/data
        - name: vault-plugins
          mountPath: /app/plugins
          readOnly: true
        resources:
          requests:
            memory: "128Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          capabilities:
            drop:
            - ALL
      volumes:
      - name: vault-config
        configMap:
          name: dhi-vault-config
      - name: vault-api-config
        configMap:
          name: dhi-vault-api-config
      - name: vault-tls
        secret:
          secretName: dhi-vault-tls
      - name: vault-plugins
        configMap:
          name: dhi-vault-plugins
      - name: vault-logs
        persistentVolumeClaim:
          claimName: dhi-vault-logs
      - name: vault-audit-logs
        persistentVolumeClaim:
          claimName: dhi-vault-audit-logs
        projected:
          sources:
          - serviceAccountToken:
              path: token
              expirationSeconds: 3600
              audience: vault
      - name: config
        configMap:
          name: dhi-vault-config
      - name: tls-certs
        secret:
          secretName: dhi-vault-tls
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - dhi-vault
            topologyKey: kubernetes.io/hostname
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: guardianshield.io/vault-optimized
                operator: In
                values:
                - "true"
      tolerations:
      - key: "guardianshield.io/secrets-management"
        operator: "Equal"
        value: "true"
        effect: "NoSchedule"
  volumeClaimTemplates:
  - metadata:
      name: vault-data
      labels:
        app: dhi-vault
        component: vault-storage
    spec:
      accessModes:
      - ReadWriteOnce
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 20Gi
      - key: "guardianshield.io/api-management"
        operator: "Equal"
        value: "true"
        effect: "NoSchedule"
---
apiVersion: v1
kind: Service
metadata:
  name: dhi-vault
  namespace: guardianshield
  labels:
    app: dhi-vault
    component: api-management
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: nlb
spec:
  type: ClusterIP
  ports:
  - port: 8080
    targetPort: 8080
    protocol: TCP
    name: http
  selector:
    app: dhi-vault
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: dhi-vault
  namespace: guardianshield
  labels:
    app: dhi-vault
    component: api-management
  annotations:
    eks.amazonaws.com/role-arn: "arn:aws:iam::ACCOUNT:role/dhi-vault-role"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: dhi-vault
  labels:
    app: dhi-vault
rules:
- apiGroups: [""]
  resources: ["secrets", "configmaps", "serviceaccounts"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["pods", "services", "endpoints"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["extensions", "networking.k8s.io"]
  resources: ["ingresses"]
  verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: dhi-vault
  labels:
    app: dhi-vault
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: dhi-vault
subjects:
- kind: ServiceAccount
  name: dhi-vault
  namespace: guardianshield
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: dhi-vault-config
  namespace: guardianshield
  labels:
    app: dhi-vault
data:
  config.yaml: |
    # DHI-Vault Configuration
    vault:
      url: "https://vault.guardianshield.svc.cluster.local:8200"
      verify_tls: true
      auth_method: "kubernetes"
      role: "dhi-vault-api"
    
    redis:
      url: "redis://redis.guardianshield.svc.cluster.local:6379"
      database: 2
      max_connections: 20
    
    server:
      host: "0.0.0.0"
      port: 8080
      workers: 4
    
    cors:
      allowed_origins:
        - "https://admin.guardianshield.io"
        - "https://app.guardianshield.io"
        - "https://api.guardianshield.io"
      allowed_methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
      allowed_headers: ["Authorization", "Content-Type", "X-API-Key"]
      allow_credentials: true
      max_age: 86400
    
    rate_limiting:
      enabled: true
      global_limit: 10000
      window_size: 3600
      tier_limits:
        basic: 1000
        premium: 5000
        enterprise: 20000
        developer: 10000
    
    security:
      encryption_password: "dhi-vault-secure-key-2024"
      encryption_salt: "dhi-vault-salt-2024"
      jwt_signing_key: "dhi-vault-jwt-key-2024"
      token_expiration: 3600
      refresh_token_expiration: 604800
    
    monitoring:
      metrics_enabled: true
      prometheus_endpoint: "/metrics"
      health_endpoint: "/health"
    
    logging:
      level: "INFO"
      format: "json"
      file: "/app/logs/dhi-vault.log"
    
    features:
      websocket_enabled: true
      api_versioning: true
      oauth2_enabled: true
      pki_enabled: true
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: dhi-vault
  namespace: guardianshield
  labels:
    app: dhi-vault
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/rate-limit: "1000"
    nginx.ingress.kubernetes.io/rate-limit-window: "1h"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - dhi-vault.guardianshield.io
    secretName: dhi-vault-tls
  rules:
  - host: dhi-vault.guardianshield.io
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: dhi-vault
            port:
              number: 8080
---
apiVersion: v1
kind: Secret
metadata:
  name: dhi-vault-tls
  namespace: guardianshield
  labels:
    app: dhi-vault
type: kubernetes.io/tls
data:
  # TLS certificate and key (base64 encoded)
  # These should be provided by cert-manager or manually configured
  tls.crt: ""
  tls.key: ""
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: dhi-vault
  namespace: guardianshield
  labels:
    app: dhi-vault
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: dhi-vault
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: dhi-vault
  namespace: guardianshield
  labels:
    app: dhi-vault
spec:
  podSelector:
    matchLabels:
      app: dhi-vault
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: guardianshield
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8080
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: guardianshield
    ports:
    - protocol: TCP
      port: 8200  # Vault
    - protocol: TCP
      port: 6379  # Redis
  - to: []
    ports:
    - protocol: TCP
      port: 443   # HTTPS
    - protocol: TCP
      port: 53    # DNS
    - protocol: UDP
      port: 53    # DNS